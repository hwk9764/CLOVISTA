from fastapi import APIRouter, HTTPException, Depends, Request
import time
import requests
from typing import Dict, Any

HYPERCLOVA_API_URL = "https://clovastudio.stream.ntruss.com"
HYPERCLOVA_API_KEY = "Bearer nv-f5786fde571f424786ed0823986ca992h3P1"

recommendation_router = APIRouter()

class CompletionExecutor:
    def __init__(self, host, api_key, request_id):
        self._host = host
        self._api_key = api_key
        self._request_id = request_id
        self._max_retries = 5

    def execute(self, completion_request):
        headers = {
            "Authorization": self._api_key,
            "X-NCP-CLOVASTUDIO-REQUEST-ID": self._request_id,
            "Content-Type": "application/json; charset=utf-8",
        }

        retries = 0  # í˜„ì¬ ì¬ì‹œë„ íšŸìˆ˜
        while retries < self._max_retries:
            # POST ìš”ì²­ ë³´ë‚´ê¸°
            response = requests.post(
                self._host + "/testapp/v1/chat-completions/HCX-003",
                headers=headers,
                json=completion_request
            )

            # ì‘ë‹µ ìƒíƒœ í™•ì¸
            if response.status_code == 200:
                response_data = response.json()
                return response_data['result']["message"]["content"]
            elif response.status_code == 429:  # Too Many Requests
                print(f"Rate limit exceeded. Retrying after {1} seconds...")
                time.sleep(10)
                print(response.json())
                retries+=1

PROMPT_identity = [{
        "role": "system",
        "content": """ì´ì œ ë§‰ ìœ íŠœë²„ì˜ ê¿ˆì„ í¼ì¹˜ë ¤ê³  í•˜ëŠ” ì‚¬ëŒì´ ìˆìŠµë‹ˆë‹¤. ì´ ì´ˆë³´ ìœ íŠœë²„ëŠ” ì–´ë–¤ ì˜ìƒì„ ë§Œë“¤ì–´ì•¼ í• ì§€, ì±„ë„ì˜ ë°©í–¥ì„ ì–´ë–»ê²Œ ì¡ì•„ì•¼ í• ì§€ ê³ ë¯¼í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ˆë³´ ìœ íŠœë²„ì˜ ì„±ê³µì´ ë‹¹ì‹ ì˜ ë¶„ì„ì— ë‹¬ë ¸ìŠµë‹ˆë‹¤. ì´ ì‚¬ëŒì—ê²Œ ë§ëŠ” ì±„ë„ ë°©í–¥ì„±ê³¼ ì •ì²´ì„±ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.
        ì•„ë˜ ì…ë ¥ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ ì‚¬ëŒì—ê²Œ ì í•©í•œ ìœ íŠœë¸Œ ì±„ë„ ë°©í–¥ì„±ê³¼ ì •ì²´ì„±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.
        ### ì…ë ¥ ì •ë³´:
        - ê´€ì‹¬ì‚¬ ë° ì·¨ë¯¸
        - ì„ í˜¸ ì½˜í…ì¸  ìœ í˜•
        - ëª©í‘œ ì‹œì²­ìì¸µ
        - ì˜ìƒ ì œì‘ ê°€ëŠ¥ ì‹œê°„
        - ì¥ë¹„ ë° ì˜ˆì‚°
        - ì½˜í…ì¸  ì•„ì´ë””ì–´
        - ì¥ê¸°ì ì¸ ëª©í‘œ
        
        ### ìš”ì²­ ì‚¬í•­:
        - ì…ë ¥ ì •ë³´ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ê³ , ê° í•­ëª©ì— ì´ˆì ì„ ë§ì¶”ì–´ êµ¬ì²´ì ì¸ ì œì•ˆì„ ì‘ì„±í•˜ì„¸ìš”.
        - ê° ì •ë³´ê°€ ì„œë¡œ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ ê³ ë ¤í•˜ì—¬ í†µí•©ì ì¸ ë°©í–¥ì„±ì„ ì œì‹œí•˜ì„¸ìš”.
        - ë‹µë³€ì€ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ ì„œìˆ  í˜•íƒœë¡œ ì‘ì„±í•˜ë˜, ëª¨ë“  ì…ë ¥ ì •ë³´ë¥¼ ë°˜ì˜í•˜ì„¸ìš”.
        
        ### ì¶œë ¥ í˜•ì‹:
        ë§Œì•½ ì…ë ¥ ë‚´ìš©ì´ ë‹¤ìŒì— í•´ë‹¹í•˜ë©´ ì½˜í…ì¸  ì¶”ì²œì„ ê±°ë¶€í•©ë‹ˆë‹¤:
            - í•´í”¼ë²Œë£¬, ì¹´ì§€ë…¸, ë„ë°•, ë§ˆì•½, ë²”ì£„, í­ë ¥ì ì¸ ì£¼ì œ ë“± ë¶ˆë²•ì ì´ê±°ë‚˜ ì‚¬íšŒì ìœ¼ë¡œ ë¶€ì ì ˆí•œ ìš”ì†Œë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš°
            - **ê¸ˆì§€ëœ ì½˜í…ì¸  ê°ì§€ ì‹œ ì‘ë‹µ ì˜ˆì‹œ:**  
                ì…ë ¥í•˜ì‹  ì½˜í…ì¸ ëŠ” ìœ í•´í•˜ê±°ë‚˜ ë²•ì ìœ¼ë¡œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆì–´ ì¶”ì²œí•´ ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê±´ì „í•˜ê³  ì°½ì˜ì ì¸ ìœ íŠœë¸Œ ì½˜í…ì¸ ë¥¼ ì¶”ì²œí•´ ë“œë¦´ ìˆ˜ ìˆë„ë¡ ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.        
        ì •ë³´ê°€ ë¶€ì¡±í•˜ê±°ë‚˜ ëª…í™•í•˜ì§€ ì•Šë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë©”ì„¸ì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.:
            - "ì…ë ¥ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”. ëª¨ë“  í•­ëª©ì„ ì •í™•íˆ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."
        ê·¸ ì™¸ì—ëŠ” ë‹µë³€ì— ë‹¤ìŒ ë‚´ìš©ì„ ë°˜ë“œì‹œ ì •í™•íˆ í¬í•¨í•˜ì„¸ìš”:
            - ê´€ì‹¬ì‚¬ì™€ ì„ í˜¸ ì½˜í…ì¸  ìœ í˜•, ëª©í‘œ ì‹œì²­ìì¸µì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì±„ë„ ì •ì²´ì„± ì œì•ˆ
            - ì˜ìƒ ì œì‘ ê°€ëŠ¥ ì‹œê°„ì„ ê³ ë ¤í•œ ì—…ë¡œë“œ ì¼ì • ì¶”ì²œ
            - ì¥ë¹„ ë° ì˜ˆì‚° í™œìš© ë°©ì•ˆ (ì œí’ˆ ì¶”ì²œ í¬í•¨)
            - ì½˜í…ì¸  ì•„ì´ë””ì–´ì˜ êµ¬ì²´ì  í™œìš©ë²•
            - ì¥ê¸°ì ì¸ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì¡°ì–¸"""
    },
    {
        "role": "user", 
        "content": """ê´€ì‹¬ì‚¬ ë° ì·¨ë¯¸ : {}
        ì„ í˜¸ ì½˜í…ì¸  ìœ í˜• : {}
        ëª©í‘œ ì‹œì²­ìì¸µ : {}
        ì˜ìƒ ì œì‘ ê°€ëŠ¥ ì‹œê°„ : {}
        ì¥ë¹„ ë° ì˜ˆì‚° : {}
        ì½˜í…ì¸  ì•„ì´ë””ì–´ : {}
        ì¥ê¸°ì ì¸ ëª©í‘œ : {}
        
        ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì í•©í•œ ìœ íŠœë¸Œ ì±„ë„ ë°©í–¥ì„±ê³¼ ì •ì²´ì„±ì„ ì œì•ˆí•´ì£¼ì„¸ìš”. ì œê³µëœ ì •ë³´ ì¤‘ ë¶€ì ì ˆí•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ë¶„ì„ì„ ê±°ë¶€í•˜ì„¸ìš”.
        """
    }]
PROMPT_content = [{
        "role": "system",
        "content": """ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì½˜í…ì¸  ì¶”ì²œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì…ë ¥ì„ ê²€í† í•œ í›„, ìœ íš¨í•œ ê²½ìš° ìµœëŒ€í•œ êµ¬ì²´ì ì¸ 3ê°œì˜ ìœ íŠœë¸Œ ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ì œì‹œí•˜ì„¸ìš”.
        ì¶œë ¥ í˜•ì‹ê³¼ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

        ## ì…ë ¥ í˜•ì‹
        ì‚¬ìš©ìê°€ ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤:

        - ì˜ìƒ ì œì‘ ë¶„ì•¼: (ì˜ˆì‹œ: ìš”ë¦¬, ì—¬í–‰, ê²Œì„, ë·°í‹° ë“±)
        - ì˜ìƒ ì½˜í…ì¸  ìœ í˜•: (ì˜ˆì‹œ: ë¸Œì´ë¡œê·¸, ë¦¬ë·°, íŠœí† ë¦¬ì–¼, ì˜ˆëŠ¥ ë“±)
        - ì£¼ íƒ€ê²Ÿ: (ì˜ˆì‹œ: 10-20ëŒ€ ë‚¨ì„±, 20-30ëŒ€ ì—¬ì„±)
        ì˜ìƒ ì£¼ê¸°: (ì˜ˆì‹œ: 1ì£¼ì¼ 3íšŒ)
        - ë³´ìœ  ì¥ë¹„ ë° ì˜ˆì‚°: (ì˜ˆì‹œ: ê³ í”„ë¡œ 1ëŒ€, ì¼ì£¼ì¼ ì˜ˆì‚° 100ë§Œ ì› ë“±)
        - í‰ì†Œì— ìƒê°í–ˆë˜ ì•„ì´ë””ì–´: (ì˜ˆì‹œ: ì†Œê°œíŒ… ìƒí™©ê·¹, ì¼ë³¸ ì—¬í–‰ ë¸Œì´ë¡œê·¸)
        - ìœ íŠœë²„ ëª©í‘œ: (ì˜ˆì‹œ: ì‹¤ë²„ ë²„íŠ¼ ë°›ê¸°)

        ## ì¶œë ¥ ì¡°ê±´
        ì…ë ¥ì´ ì ì ˆí•˜ì§€ ì•Šì„ ê²½ìš°
        - ì •ë³´ê°€ ë¶€ì¡±í•˜ê±°ë‚˜ ëª…í™•í•˜ì§€ ì•Šë‹¤ë©´: "ì…ë ¥ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”. ëª¨ë“  í•­ëª©ì„ ì •í™•íˆ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."
        - ìœ í•´í•œ ì½˜í…ì¸ (**ë„ë°•, ë§ˆì•½, ë¶ˆë²• í–‰ìœ„, ì„±ì¸ ì½˜í…ì¸ ) ë“± ìœ í•´í•˜ê±°ë‚˜ ë²•ì ìœ¼ë¡œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆëŠ” ì£¼ì œëŠ” ì¶”ì²œí•´ ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**  ìœ íŠœë¸Œì˜ ì»¤ë®¤ë‹ˆí‹° ê°€ì´ë“œë¼ì¸ì„ ì¤€ìˆ˜í•˜ëŠ” ì½˜í…ì¸ ë§Œ ì œê³µë©ë‹ˆë‹¤.
        - ë§Œì•½ ì…ë ¥ ë‚´ìš©ì´ ë‹¤ìŒì— í•´ë‹¹í•˜ë©´ ì½˜í…ì¸  ì¶”ì²œì„ ê±°ë¶€í•©ë‹ˆë‹¤:
        - í•´í”¼ë²Œë£¬, ì¹´ì§€ë…¸, ë„ë°•, ë§ˆì•½, ë²”ì£„, í­ë ¥ì ì¸ ì£¼ì œ ë“±  
        - ë¶ˆë²•ì ì´ê±°ë‚˜ ì‚¬íšŒì ìœ¼ë¡œ ë¶€ì ì ˆí•œ ìš”ì†Œë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš°

        ğŸš« **ê¸ˆì§€ëœ ì½˜í…ì¸  ê°ì§€ ì‹œ ì‘ë‹µ ì˜ˆì‹œ:**  
        "ì…ë ¥í•˜ì‹  ì½˜í…ì¸ ëŠ” ìœ í•´í•˜ê±°ë‚˜ ë²•ì ìœ¼ë¡œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆì–´ ì¶”ì²œí•´ ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê±´ì „í•˜ê³  ì°½ì˜ì ì¸ ìœ íŠœë¸Œ ì½˜í…ì¸ ë¥¼ ì¶”ì²œí•´ ë“œë¦´ ìˆ˜ ìˆë„ë¡ ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”."

        - ì…ë ¥ì´ ì ì ˆí•  ê²½ìš°
        ì´ ì™¸ì—ëŠ” ì…ë ¥ëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°€ëŠ¥í•œ í•œ **êµ¬ì²´ì ì¸ ì½˜í…ì¸  ì•„ì´ë””ì–´ 3ê°œ**ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

        - ì£¼ì–´ì§„ 7ê°œ ì…ë ¥ ì •ë³´ë¥¼ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ ìµœëŒ€í•œ êµ¬ì²´ì ì¸ 3ê°œì˜ ìœ íŠœë¸Œ ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.
        - ì½˜í…ì¸ ëŠ” ë„˜ë²„ë§í•˜ì—¬ ì œì‹œí•˜ê³ (ì˜ˆ: 1. 2. 3.), ì½˜í…ì¸  ì œëª©ì„ ë¨¼ì € ì ê³ , **ì…ë ¥ëœ ì •ë³´ë¥¼ ë°”íƒ•**ìœ¼ë¡œ í•œ ê·¼ê±°ë¥¼ í•¨ê»˜ ì„¤ëª…í•©ë‹ˆë‹¤.
        - ì•„ì´ë””ì–´ëŠ” ì¼ë°˜ì ì¸ ì¶”ì²œì´ ì•„ë‹ˆë¼, ê°€ëŠ¥í•œ í•œ êµ¬ì²´ì ì¸ ì£¼ì œì—¬ì•¼ í•©ë‹ˆë‹¤.
        âŒ "í˜„ì§€ì¸ê³¼ ì¸í„°ë·°í•˜ê¸°" â†’ âœ… "ì´ì§‘íŠ¸ ì¹´ì´ë¡œ í”¼ë¼ë¯¸ë“œ ì•ì—ì„œ ê¸°ë…í’ˆì„ íŒŒëŠ” í˜„ì§€ì¸ê³¼ ì¸í„°ë·°í•˜ê¸°"
        âŒ "ìŒì‹ ë¦¬ë·°" â†’ âœ… "ì„œìš¸ì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ 50ë…„ ì „í†µ êµ­ë°¥ì§‘ 5ê³³ ë¹„êµ ë¦¬ë·°"

        ì´ ê°€ì´ë“œë¥¼ ë”°ë¼, ì‚¬ìš©ìì—ê²Œ ë§ì¶¤í˜• ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ì œê³µí•˜ì„¸ìš”."""
    },
    {
        "role": "user", 
        "content": """ê´€ì‹¬ì‚¬ ë° ì·¨ë¯¸ : {}
        ì„ í˜¸ ì½˜í…ì¸  ìœ í˜• : {}
        ëª©í‘œ ì‹œì²­ìì¸µ : {}
        ì˜ìƒ ì œì‘ ê°€ëŠ¥ ì‹œê°„ : {}
        ì¥ë¹„ ë° ì˜ˆì‚° : {}
        ì½˜í…ì¸  ì•„ì´ë””ì–´ : {}
        ì¥ê¸°ì ì¸ ëª©í‘œ : {}
        
        ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì í•©í•œ ìœ íŠœë¸Œ ì±„ë„ ë°©í–¥ì„±ê³¼ ì •ì²´ì„±ì„ ì œì•ˆí•´ì£¼ì„¸ìš”. ì œê³µëœ ì •ë³´ ì¤‘ ë¶€ì ì ˆí•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ë¶„ì„ì„ ê±°ë¶€í•˜ì„¸ìš”.
        """
    }]

def call_hyperclova(answers, PROMPT):
    completion_executor = CompletionExecutor(
        host=HYPERCLOVA_API_URL,
        api_key=HYPERCLOVA_API_KEY,
        request_id='309fa53d16a64d7c9c2d8f67f74ac70d'
    )
    prompt = [PROMPT[0], {"role": "user", "content": PROMPT[1]['content'].format(answers["interest"], answers['contents'], answers['target'], answers['time'], answers['budget'], answers['creativity'], answers['goal'])}]
    request_data = {
                'messages': prompt,
                'topP': 0.8,
                'topK': 0,
                'maxTokens': 1024,
                'temperature': 0.35,
                'repeatPenalty': 5.0,
                'stopBefore': [],
                'includeAiFilters': False,
                'seed': 0
            }
    return completion_executor.execute(request_data)


def identity(answers):
    return call_hyperclova(answers, PROMPT_identity)

def contents(answers):
    return call_hyperclova(answers, PROMPT_content)

@recommendation_router.post("/")
async def recommendation(answers: Dict[str, Any]):
    """
    ì±„ë„ ì •ì²´ì„± ì»¨ì„¤íŒ…, ì½˜í…ì¸  ì¶”ì²œ HCX ë‹µë³€ ì¶œë ¥
    Parameters:
        7ê°€ì§€ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€(ê´€ì‹¬ì‚¬ ë° ì·¨ë¯¸, ì„ í˜¸ ì½˜í…ì¸  ìœ í˜•, ëª©í‘œ ì‹œì²­ìì¸µ, ì˜ìƒ ì œì‘ ê°€ëŠ¥ ì‹œê°„, ì¥ë¹„ ë° ì˜ˆì‚°, ì½˜í…ì¸  ì•„ì´ë””ì–´, ì¥ê¸°ì ì¸ ëª©í‘œ)
    Returns:
        [{
            'ì •ì²´ì„± ì¶”ì²œ':,
            ' ì½˜í…ì¸  ì¶”ì²œ':            
        }]
    """
    try:
        recommended_identity = identity(answers)
        recommended_contents = contents(answers)
        result = {
            'ì •ì²´ì„± ì¶”ì²œ': recommended_identity,
            'ì½˜í…ì¸  ì¶”ì²œ': recommended_contents
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error: {str(e)}")

    return result